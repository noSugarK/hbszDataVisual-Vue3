# 物资采购与价格管理系统 - API接口设计文档（修订版）

## 一、接口概述

### 1.1 基本信息
- 系统名称：物资采购与价格管理系统
- 接口版本：v1
- 基础路径：`/api/v1`
- 数据格式：JSON
- 认证方式：JWT (JSON Web Token)
- 开发框架：Django REST Framework (后端)，Vue 3 (前端)

### 1.2 接口规范
- 采用RESTful设计风格
- HTTP方法定义：
  - GET：查询资源
  - POST：创建资源
  - PUT：全量更新资源
  - PATCH：部分更新资源
  - DELETE：删除资源
- 状态码使用：
  - 200：成功
  - 201：创建成功
  - 400：请求参数错误
  - 401：未认证
  - 403：权限不足
  - 404：资源不存在
  - 500：服务器内部错误

### 1.3 分页规范
所有列表查询接口默认支持分页，分页参数：
- `page`：页码，默认1
- `page_size`：每页条数，默认20，允许用户自定义（范围：10-100）

分页响应格式：
```json
{
  "count": 100,          // 总记录数
  "next": "http://example.com/api/v1/resource/?page=2&page_size=20",  // 下一页URL
  "previous": null,      // 上一页URL
  "results": [ ... ]     // 当前页数据
}
```

### 1.4 权限控制说明
- 超级管理员（is_superuser=true）：可访问所有接口
- 管理员（is_staff=true且is_superuser=false）：可访问大部分接口，受限于管理员权限
- 普通用户：仅可访问被授权的接口和数据

## 二、认证接口

### 2.1 用户登录
- 路径：`/auth/login/`
- 方法：POST
- 描述：用户登录并获取 JWT 令牌，支持前端密码加密传输，后端基于 Django 内置加密机制验证
- 频率限制：同一 IP / 用户名 5 分钟内最多 5 次请求（超出返回 429 状态码）


- 前端加密：
  ```javascript
  // 前端密码加密代码（使用CryptoJS库）
  import CryptoJS from 'crypto-js';

  // 1. 用户输入原始密码
  const rawPassword = "用户输入的明文密码";

  // 2. 执行SHA-256哈希（输出16进制字符串）
  const encryptedPassword = CryptoJS.SHA256(rawPassword).toString(CryptoJS.enc.Hex);

  // 示例结果：rawPassword = "MySecurePass123!" → encryptedPassword = "eFgH2iJ4kL6mN8oP1qR3sT5uV7wX9yZ1aBcD3eFgH5"
  ```
  请求体：
  ```json
  {
    "username": "string",
    "password": "string", // SHA-256 加密后的密码（非明文）
    "remember_me": boolean  // 可选，默认false
  }
  ```
- 后端验证逻辑（Django 内置机制）
  - 接收前端传来的 username 和 encryptedPassword；
  - 根据用户名查询数据库，获取存储的 Django 标准加密密码（格式：algorithm$iterations$salt$hash）；
  - 提取存储密码中的加密参数（算法、迭代次数、盐值）；
  - 用提取的参数对 encryptedPassword 执行 PBKDF2 加密，生成验证哈希值；
  - 对比验证哈希值与数据库存储的哈希值，一致则验证通过。
  
  响应（200 OK）：
  ```json
  {
    "access": "string",    // 访问令牌
    "refresh": "string",   // 刷新令牌
    "user": {
      "id": int,
      "username": "string",
      "first_name": "string",
      "is_superuser": boolean,
      "is_staff": boolean,
      "permissions": {
        "projects": [{"id": int, "name": "string", "permission_type": "string"}],
        "regions": [{"id": int, "name": "string", "permission_type": "string"}]
      }
    }
  }
  ```

### 2.2 刷新令牌
- 路径：`/auth/token/refresh/`
- 方法：POST
- 描述：使用刷新令牌获取新的访问令牌
- 请求体：
  ```json
  {
    "refresh": "string"
  }
  ```
- 响应（200 OK）：
  ```json
  {
    "access": "string"
  }
  ```

### 2.3 用户登出
- 路径：`/auth/logout/`
- 方法：POST
- 描述：用户登出，使当前令牌失效
- 请求头：`Authorization: Bearer {token}`
- 请求体：
  ```json
  {
    "refresh": "string"
  }
  ```
- 响应（204 No Content）

### 2.4 密码重置请求
- 路径：`/auth/password-reset/`
- 方法：POST
- 描述：发送密码重置邮件
- 请求体：
  ```json
  {
    "email": "string"
  }
  ```
- 响应（200 OK）：
  ```json
  {
    "message": "密码重置邮件已发送"
  }
  ```

## 三、用户管理接口

### 3.1 用户列表
- 路径：`/users/`
- 方法：GET
- 权限：管理员或超级管理员
- 描述：获取用户列表，支持搜索和筛选
- 查询参数：
  - `username`：用户名模糊搜索
  - `is_active`：是否激活
  - `is_staff`：是否为管理员
  - `is_superuser`：是否为超级用户
- 响应（200 OK）：分页用户列表

### 3.2 创建用户
- 路径：`/users/`
- 方法：POST
- 权限：
  - 超级管理员：可创建所有类型用户
  - 管理员：只能创建普通用户（is_staff=false且is_superuser=false）
- 描述：创建新用户
- 请求体：
  ```json
  {
    "username": "string",
    "password": "string",
    "first_name": "string",
    "email": "string",
    "phone": "string",
    "is_active": boolean,
    "is_staff": boolean,  // 仅超级管理员可设置为true
    "is_superuser": boolean  // 仅超级管理员可设置为true
  }
  ```
- 响应（201 Created）：创建的用户详情

### 3.3 用户详情
- 路径：`/users/{id}/`
- 方法：GET
- 权限：管理员、超级管理员或本人
- 描述：获取指定用户详情
- 响应（200 OK）：用户详细信息

### 3.4 更新用户
- 路径：`/users/{id}/`
- 方法：PUT/PATCH
- 权限：
  - 超级管理员：可更新所有用户的所有字段
  - 管理员：只能更新普通用户的非权限字段
  - 本人：只能更新个人信息字段
- 描述：更新用户信息
- 请求体：用户字段（PUT全量，PATCH部分）
- 响应（200 OK）：更新后的用户详情

### 3.5 删除用户
- 路径：`/users/{id}/`
- 方法：DELETE
- 权限：
  - 超级管理员：可删除所有用户
  - 管理员：只能删除普通用户
- 描述：删除指定用户
- 响应（204 No Content）

## 四、权限管理接口

### 4.1 项目权限列表
- 路径：`/project-permissions/`
- 方法：GET
- 权限：管理员或超级管理员
- 描述：获取所有用户的项目权限列表
- 查询参数：
  - `user_id`：用户ID筛选
  - `project_id`：项目ID筛选
- 响应（200 OK）：分页的项目权限列表

### 4.2 分配项目权限
- 路径：`/project-permissions/`
- 方法：POST
- 权限：管理员或超级管理员
- 描述：为用户分配项目权限
  对于权限描述：
  - view：查看权限、可查看该项目所有填报信息
  - edit：编辑权限、可编辑该项目所有填报信息、但不能修改项目信息
  - add：添加权限、仅可填写该项目的新填报信息并查看该项目本人填写的记录
  - manage：管理权限、可管理该项目所有填报信息，包括编辑、删除等操作
- 请求体：
  ```json
  {
    "user_id": int,
    "project_id": int,
    "permission_type": "string"  // view|edit|add|manage
  }
  ```
- 响应（201 Created）：创建的权限记录

### 4.3 更新项目权限
- 路径：`/project-permissions/{id}/`
- 方法：PATCH
- 权限：管理员或超级管理员
- 描述：更新用户的项目权限
- 请求体：
  ```json
  {
    "permission_type": "string"  // view|edit|add|manage
  }
  ```
- 响应（200 OK）：更新后的权限记录

### 4.4 删除项目权限
- 路径：`/project-permissions/{id}/`
- 方法：DELETE
- 权限：管理员或超级管理员
- 描述：删除用户的项目权限
- 响应（204 No Content）

### 4.9 用户权限详情
- 路径：`/users/{id}/permissions/`
- 方法：GET
- 权限：管理员、超级管理员或本人
- 描述：获取指定用户的所有权限详情
- 响应（200 OK）：
  ```json
  {
    "projects": [
      {
        "id": int,
        "project_id": int,
        "project_name": "string",
        "permission_type": "string"
      }
    ],
    /*
    "regions": [
      {
        "id": int,
        "region_id": int,
        "region_name": "string",
        "permission_type": "string"
      }
    ]
    */
  }
  ```

## 五、地区管理接口

### 5.1 地区列表
- 路径：`/regions/`
- 方法：GET
- 描述：获取地区列表，支持筛选
- 查询参数：
  - `level`：级别（city/district）
  - `parent_id`：父级地区ID
- 响应（200 OK）：分页地区列表（根据用户权限过滤）

### 5.2 地区树形结构
- 路径：`/regions/tree/`
- 方法：GET
- 描述：获取地区树形结构数据
- 响应（200 OK）：
  ```json
  [
    {
      "id": int,
      "name": "string",
      "level": "string",
      "parent_id": int,
      "children": [ ... ]  // 子地区
    }
  ]
  ```

### 5.3 创建地区
- 路径：`/regions/`
- 方法：POST
- 权限：管理员或超级管理员
- 描述：创建新地区
- 请求体：
  ```json
  {
    "name": "string",
    "level": "string",  // city或district
    "parent_id": int    // 可选，仅district需要
  }
  ```
- 响应（201 Created）：创建的地区详情

### 5.4 地区详情/更新/删除
- 路径：`/regions/{id}/`
- 方法：GET/PUT/PATCH/DELETE
- 权限：
  - GET：所有已认证用户
  - 其他：管理员或超级管理员
- 描述：地区的查改删操作
- 响应：相应的状态码和数据

## 六、项目管理接口

### 6.1 项目列表
- 路径：`/projects/`
- 方法：GET
- 描述：获取项目列表，支持筛选
- 查询参数：
  - `name`：项目名称模糊搜索
  - `status`：项目状态（active/inactive/closed）
  - `region_id`：所属地区ID
- 响应（200 OK）：分页项目列表（根据用户权限过滤）

### 6.2 创建项目
- 路径：`/projects/`
- 方法：POST
- 权限：管理员、超级管理员
- 描述：创建新项目
- 请求体：
  ```json
  {
    "project_name": "string",
    "region_id": int,
    "active": string,  // active/inactive/closed
    "created_by": int  // 默认为当前登录用户
  }
  ```
- 响应（201 Created）：创建的项目详情

### 6.3 项目详情/更新/删除
- 路径：`/projects/{id}/`
- 方法：GET/PUT/PATCH/DELETE
- 权限：
  - GET：所有已认证用户（根据权限过滤）
  - 其他：管理员、超级管理员或有项目manage权限的用户
- 描述：项目的查改删操作
- 响应：相应的状态码和数据

### 6.4 项目关联订单
- 路径：`/projects/{id}/orders/`
- 方法：GET
- 权限：根据用户权限过滤
- 描述：获取指定项目的所有采购订单
- 响应（200 OK）：分页采购订单列表

## 七、物资类别与规格接口

### 7.1 物资类别列表
- 路径：`/categories/`
- 方法：GET
- 描述：获取物资类别列表
- 响应（200 OK）：分页物资类别列表

### 7.2 物资类别CRUD
- 路径：`/categories/` 和 `/categories/{id}/`
- 方法：POST/GET/PUT/PATCH/DELETE
- 权限：
  - GET：所有已认证用户
  - 其他：管理员或超级管理员
- 描述：物资类别的增删改查
- 请求体（POST/PUT/PATCH）：
  ```json
  {
    "category_name": "string"
  }
  ```
- 响应：相应的状态码和数据

### 7.3 规格列表
- 路径：`/specifications/`
- 方法：GET
- 描述：获取规格列表，支持筛选
- 查询参数：
  - `category_id`：物资类别ID
- 响应（200 OK）：分页规格列表

### 7.4 规格CRUD
- 路径：`/specifications/` 和 `/specifications/{id}/`
- 方法：POST/GET/PUT/PATCH/DELETE
- 权限：
  - GET：所有已认证用户
  - 其他：管理员或超级管理员
- 描述：规格的增删改查
- 请求体（POST/PUT/PATCH）：
  ```json
  {
    "specification_name": "string",
    "category_id": int
  }
  ```
- 响应：相应的状态码和数据

### 7.5 物资类别及规格组合列表（新增）
- 路径：/materials/
- 方法：GET
- 描述：获取物资类别及其对应规格的组合列表，用于物资列表展示
- 查询参数：
  - category_name：物资类别名称模糊搜索
  - specification_name：规格名称模糊搜索
- 响应（200 OK）：分页列表，包含物资类别及其规格信息

```json
{
  "count": 100,
  "next": "http://example.com/api/v1/materials/?page=2",
  "previous": null,
  "results": [
    {
      "category_id": int,
      "category_name": "string",
      "specifications": [
        {
          "specification_id": int,
          "specification_name": "string"
        }
      ]
    }
  ]
}
```

## 八、采购订单接口

### 8.1 采购订单列表
- 路径：`/orders/`
- 方法：GET
- 描述：获取采购订单列表，支持多条件筛选
- 查询参数：
  - `project_id`：项目ID
  - `region_id`：地区ID
  - `supplier_id`：供应商ID
  - `category_id`：物资类别ID
  - `specification_id`：规格ID
  - `brand_id`：品牌ID
  - `arrival_date_start`：到货时间起始
  - `arrival_date_end`：到货时间结束
  - `status`：订单状态
- 响应（200 OK）：分页采购订单列表（根据用户权限过滤）

### 8.2 创建采购订单
- 路径：`/orders/`
- 方法：POST
- 权限：管理员、超级管理员或有项目edit/manage权限的用户
- 描述：创建新采购订单
- 请求体：
  ```json
  {
    "project_id": int,
    "arrival_date": "YYYY-MM-DD",
    "supplier_id": int,
    "category_id": int,
    "specification_id": int,
    "quantity": decimal,
    "purchase_price": decimal,
    "discount_rate": decimal,  // 折扣率，如0.05表示5%
    "brand_id": int,
    "status": "string"  // 订单状态
  }
  ```
- 响应（201 Created）：创建的采购订单详情（包含自动计算的total_amount）

### 8.3 采购订单详情/更新/删除
- 路径：`/orders/{id}/`
- 方法：GET/PUT/PATCH/DELETE
- 权限：
  - GET：有项目view权限的用户
  - 其他：管理员、超级管理员或有项目edit/manage权限的用户
- 描述：采购订单的查改删操作
- 响应：相应的状态码和数据

### 8.4 更新订单状态
- 路径：`/orders/{id}/status/`
- 方法：PATCH
- 权限：管理员、超级管理员或有项目manage权限的用户
- 描述：单独更新订单状态
- 请求体：
  ```json
  {
    "status": "string",
    "approved_by": int  // 可选，默认为当前用户
  }
  ```
- 响应（200 OK）：更新后的订单详情（包含approved_at时间戳）

## 九、指导价格接口

### 9.1 指导价价格列表
- 路径：`/guide-prices/`
- 方法：GET
- 描述：获取指导价格列表，支持多条件筛选
- 查询参数：
  - `region_id`：地区ID
  - `category_id`：物资类别ID
  - `specification_id`：规格ID
  - `date_start`：日期起始
  - `date_end`：日期结束
- 响应（200 OK）：分页指导价格列表（根据用户权限过滤）

### 9.2 创建指导价格
- 路径：`/guide-prices/`
- 方法：POST
- 权限：管理员、超级管理员或有地区edit/manage权限的用户
- 描述：创建新指导价格记录
- 请求体：
  ```json
  {
    "date": "YYYY-MM",  // 年月
    "region_id": int,
    "specification_id": int,
    "category_id": int,
    "unit_price": decimal
  }
  ```
- 响应（201 Created）：创建的指导价格详情

### 9.3 指导价格详情/更新/删除
- 路径：`/guide-prices/{id}/`
- 方法：GET/PUT/PATCH/DELETE
- 权限：
  - GET：有地区view权限的用户
  - 其他：管理员、超级管理员或有地区edit/manage权限的用户
- 描述：指导价格的查改删操作
- 响应：相应的状态码和数据

### 9.4 批量导入指导价格
- 路径：`/guide-prices/batch-import/`
- 方法：POST
- 权限：管理员、超级管理员或有地区manage权限的用户
- 描述：通过Excel批量导入指导价格
- 请求体：`multipart/form-data` 包含Excel文件
- 响应（200 OK）：
  ```json
  {
    "submission_id": int,  // 数据提交记录ID
    "success_count": int,
    "fail_count": int,
    "status": "string"
  }
  ```

## 十、数据提交记录接口

### 10.1 数据提交记录列表
- 路径：`/data-submissions/`
- 方法：GET
- 权限：管理员、超级管理员或提交者本人
- 描述：获取数据提交记录列表，支持筛选
- 查询参数：
  - `user_id`：提交用户ID
  - `source_type`：来源类型
  - `status`：状态
  - `submission_type`：提交类型
  - `submitted_at_start`：提交时间起始
  - `submitted_at_end`：提交时间结束
- 响应（200 OK）：分页数据提交记录列表（根据用户权限过滤）

### 10.2 数据提交记录详情
- 路径：`/data-submissions/{id}/`
- 方法：GET
- 权限：管理员、超级管理员或提交者本人
- 描述：获取指定数据提交记录的详情
- 响应（200 OK）：数据提交记录详情（包含错误日志）

### 10.3 处理数据提交
- 路径：`/data-submissions/{id}/process/`
- 方法：POST
- 权限：管理员或超级管理员
- 描述：处理待处理的数据提交
- 响应（200 OK）：处理后的记录详情

## 十一、可视化分析接口

### 11.1 地区价格趋势
- 路径：`/analytics/region-price-trend/`
- 方法：GET
- 权限：有相应地区view权限的用户
- 描述：获取指定地区和物资的价格趋势数据
- 查询参数：
  - `region_ids`：地区ID，多个用逗号分隔
  - `category_id`：物资类别ID
  - `specification_id`：规格ID
  - `start_date`：开始日期（YYYY-MM）
  - `end_date`：结束日期（YYYY-MM）
- 响应（200 OK）：价格趋势数据（根据用户权限过滤）

### 11.2 项目采购对比
- 路径：`/analytics/project-purchase-comparison/`
- 方法：GET
- 权限：有相应项目view权限的用户
- 描述：获取项目采购价格对比数据
- 查询参数：
  - `project_ids`：项目ID，多个用逗号分隔
  - `category_id`：物资类别ID
  - `start_date`：开始日期
  - `end_date`：结束日期
- 响应（200 OK）：项目采购对比数据（根据用户权限过滤）

### 11.3 订单金额趋势
- 路径：`/analytics/order-amount-trend/`
- 方法：GET
- 权限：已认证用户
- 描述：获取订单数量与金额趋势数据
- 查询参数：
  - `period`：周期（month/quarter/year）
  - `start_date`：开始日期
  - `end_date`：结束日期
  - `region_id`：可选，地区筛选
- 响应（200 OK）：订单金额趋势数据（根据用户权限过滤）

### 11.4 供应商采购占比
- 路径：`/analytics/supplier-purchase-ratio/`
- 方法：GET
- 权限：已认证用户
- 描述：获取供应商采购占比数据
- 查询参数：
  - `project_id`：可选，项目筛选
  - `region_id`：可选，地区筛选
  - `start_date`：开始日期
  - `end_date`：结束日期
- 响应（200 OK）：供应商采购占比数据（根据用户权限过滤）

## 十二、错误码说明

| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 40001 | 参数验证错误 | 检查请求参数是否符合要求 |
| 40101 | 未认证 | 需要先登录获取令牌 |
| 40102 | 令牌过期 | 需要刷新令牌或重新登录 |
| 40301 | 权限不足 | 没有操作该资源的权限 |
| 40302 | 角色权限限制 | 该角色不允许执行此操作 |
| 40401 | 资源不存在 | 检查请求的资源ID是否正确 |
| 50001 | 服务器内部错误 | 联系系统管理员 |
| 50002 | 数据库错误 | 联系系统管理员 |
| 50003 | 文件处理错误 | 检查文件格式和内容是否正确 |

## 十三、附录：数据模型字段说明

各接口中涉及的数据模型字段与数据库表设计保持一致，主要字段说明如下：

1. **USER**：id, username, password, first_name, is_superuser, is_staff, is_active, date_joined, phone, email, created_by, last_login
2. **PROJECT_PERMISSION**：id, user_id, project_id, permission_type
4. **REGION**：id, name, level, parent_id
5. **PROJECT**：id, project_name, region_id
6. **CATEGORY**：id, category_name
7. **SPECIFICATION**：id, specification_name, category_id
8. **BRAND**：id, brand_name, description
9. **SUPPLIER**：id, supplier_name
10. **PURCHASE_ORDER**：id, project_id, arrival_date, supplier_id, category_id, specification_id, quantity, purchase_price, discount_rate, total_amount, brand_id, user_id, status, approved_by, approved_at
11. **GUIDE_PRICE**：id, date, region_id, specification_id, category_id, unit_price, user_id
12. **DATA_SUBMISSION**：id, user_id, source_type, file_path, record_count, status, error_log, submitted_at, processed_at, submission_type

本接口设计文档将根据系统开发进度和需求变化进行更新和完善。